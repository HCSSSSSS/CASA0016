#include <Wire.h>
#include <SparkFun_SCD30_Arduino_Library.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include "GasBreakout.h"

// Hardware Pin Configuration
#define I2C_SDA    21
#define I2C_SCL    22
#define PIN_BUZZER 13

// OLED Display Settings
#define SCREEN_WIDTH  128
#define SCREEN_HEIGHT 64
#define OLED_RESET    -1
#define OLED_ADDR     0x3C

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Sensor Objects
SCD30 scd30;
GasBreakout gas(Wire, 0x19);

// Sensor Status Flags
bool scd30_ok = false;
bool gas_ok   = false;

// Data Buffers
float lastCo2   = NAN;
float lastTemp  = NAN;
float lastHum   = NAN;

// Gas Sensor Variables
float baselineReducing = NAN;
float lastCOIndex      = NAN;

// Safety Thresholds
const float CO2_WARN        = 1000.0;
const float CO2_DANGER      = 1500.0;
const float CO_INDEX_DANGER = 50.0;  

// Timing Constants
const unsigned long GAS_READ_INTERVAL        = 5000;
const unsigned long DISPLAY_UPDATE_INTERVAL  = 2000;
unsigned long lastGasRead      = 0;
unsigned long lastDisplayUpdate = 0;

// State Tracking
bool lastDangerState = false;

// Trigger audible alarm
void triggerAlarmOnce() {
  digitalWrite(PIN_BUZZER, HIGH);
  delay(120);
  digitalWrite(PIN_BUZZER, LOW);
  delay(120);
  digitalWrite(PIN_BUZZER, HIGH);
  delay(120);
  digitalWrite(PIN_BUZZER, LOW);
}

// Render User Interface on OLED
void drawScreen(bool isDanger) {
  display.clearDisplay();

  // CO2 Label
  display.setCursor(0, 0);
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.print(F("CO2 ppm"));
  
  // CO2 Value
  display.setCursor(0, 12);
  if (!isnan(lastCo2)) {
    if(lastCo2 < 1000) display.setTextSize(3); else display.setTextSize(2);
    display.print((int)lastCo2);
  } else {
    display.setTextSize(2);
    display.print(F("----"));
  }

  // Vertical Separator
  display.drawLine(75, 0, 75, 35, SSD1306_WHITE);
  
  // Temperature
  display.setTextSize(1);
  display.setCursor(80, 4); 
  display.print(F("T:")); 
  if(!isnan(lastTemp)) display.print(lastTemp, 0); else display.print(F("--"));
  display.print(F("C"));

  // Humidity
  display.setCursor(80, 20); 
  display.print(F("H:")); 
  if(!isnan(lastHum)) display.print(lastHum, 0); else display.print(F("--"));
  display.print(F("%"));

  // Operation Indicator
  if ((millis() / 1000) % 2 == 0) {
    display.fillCircle(124, 32, 2, SSD1306_WHITE);
  }

  // Status Logic (Updated to include CO check)
  String statusText = "INIT...";
  bool invertColor = false; 
  
  // Check CO levels first (Higher Priority)
  bool highCO = (!isnan(lastCOIndex) && lastCOIndex >= CO_INDEX_DANGER);
  
  if (highCO) {
    statusText = "GAS ALERT!";
    invertColor = true;
  } 
  else if (!isnan(lastCo2)) {
    if (lastCo2 < CO2_WARN) {
      statusText = "GOOD";
    } else if (lastCo2 < CO2_DANGER) {
      statusText = "BAD";
      invertColor = true;
    } else {
      statusText = "! DANGER !";
      invertColor = true;
    }
  }

  // Draw Status Bar
  int yStatus = 40; 
  if (isDanger || invertColor) {
    display.fillRect(0, yStatus-1, 128, 11, SSD1306_WHITE); 
    display.setTextColor(SSD1306_BLACK, SSD1306_WHITE);
  } else {
    display.setTextColor(SSD1306_WHITE);
  }
  
  // Center Text
  int centerOffset = (128 - (statusText.length() * 6)) / 2;
  if (centerOffset < 0) centerOffset = 0;
  
  display.setCursor(centerOffset, yStatus + 1);
  display.print(statusText);
  display.setTextColor(SSD1306_WHITE);

  // Carbon Monoxide Bar
  int yBar = 56;
  display.setCursor(0, yBar);
  display.print(F("CO:"));

  display.drawRect(20, yBar, 85, 5, SSD1306_WHITE);

  if (!isnan(lastCOIndex)) {
    int fillW = map(constrain(lastCOIndex, 0, 100), 0, 100, 0, 83);
    if(fillW > 0) {
      display.fillRect(21, yBar+1, fillW, 3, SSD1306_WHITE);
    }
    display.setCursor(110, yBar);
    display.print((int)lastCOIndex);
  }

  display.display();
}

void setup() {
  Serial.begin(115200);

  // Initialize Buzzer
  pinMode(PIN_BUZZER, OUTPUT);
  digitalWrite(PIN_BUZZER, LOW);

  // Startup Beep
  digitalWrite(PIN_BUZZER, HIGH);
  delay(150);
  digitalWrite(PIN_BUZZER, LOW);

  // Initialize I2C
  Wire.begin(I2C_SDA, I2C_SCL);

  // Initialize OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println(F("OLED init failed"));
  } else {
    display.setRotation(2);
    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(20, 25);
    display.println(F("SYSTEM ON"));
    display.display();
    delay(1000); 
  }

  // Initialize SCD30
  if (scd30.begin()) {
    scd30_ok = true;
    scd30.setMeasurementInterval(2);
    scd30.setAutoSelfCalibration(1);
    Serial.println(F("SCD30 Ready"));
  } else {
    Serial.println(F("SCD30 Failed"));
  }

  // Initialize MiCS-6814
  if (gas.initialise()) {
    gas_ok = true;
    Serial.println(F("MiCS-6814 Ready"));
  } else {
    Serial.println(F("MiCS-6814 Failed"));
  }
}

void loop() {
  unsigned long now = millis();

  // Read SCD30 Data
  if (scd30_ok && scd30.dataAvailable()) {
    lastCo2  = scd30.getCO2();
    lastTemp = scd30.getTemperature();
    lastHum  = scd30.getHumidity();

    Serial.print(F("SCD30 CO2: "));
    Serial.println(lastCo2, 1);
  }

  // Read MiCS-6814 Data
  if (gas_ok && (now - lastGasRead >= GAS_READ_INTERVAL)) {
    lastGasRead = now;
    GasBreakout::Reading r = gas.readAll();
    float R = r.reducing;

    if (isnan(baselineReducing)) {
      baselineReducing = R;
      lastCOIndex = 0;
    } else {
      if (R <= 0) {
        lastCOIndex = NAN;
      } else {
        float ratio = baselineReducing / R;
        float idx   = (ratio - 1.0f) * 50.0f;
        if (idx < 0)   idx = 0;
        if (idx > 100) idx = 100;
        lastCOIndex = idx;
      }
    }
    Serial.print(F("MiCS CO Index: "));
    Serial.println(lastCOIndex, 1);
  }

  // Update Display and Check Alarm
  if (now - lastDisplayUpdate >= DISPLAY_UPDATE_INTERVAL) {
    lastDisplayUpdate = now;

    // Determine Danger State: High CO2 OR High CO Index
    bool isDanger = (!isnan(lastCo2) && lastCo2 >= CO2_DANGER) || 
                    (!isnan(lastCOIndex) && lastCOIndex >= CO_INDEX_DANGER);

    if (isDanger && !lastDangerState) {
      triggerAlarmOnce();
    }
    lastDangerState = isDanger;

    drawScreen(isDanger);
  }

  delay(5);
}
